#!/bin/bash -e
#SBATCH --job-name=run_test_step_farming_cohort
#SBATCH --ntasks=5
#SBATCH --time=00:50:00
#SBATCH --hint=nomultithread

module purge
module load gimkl CMake

nw=$((SLURM_NTASKS - 1))
nt=$((nw * 2))
echo "Number of workers: $nw number of time steps: $nt"

csvfile="resultsNw${nw}.csv"
for nm in 2 5 10 20; do
    for nd in 5000 10000 20000; do
        csvfile="resultsNw${nw}_nm${nm}_nd${nd}.csv"
        echo "nm,nd,speedup,ideal" > $csvfile
        for i in {0..9}; do
            resfile="logNw${nw}_nm${nm}_nd${nd}_${i}.txt"
            echo "Running @CMAKE_BINARY_DIR@/tests/testTaskStepFarmingCohort -na $nw -nt $nt >& $resfile"
            srun @CMAKE_BINARY_DIR@/tests/testTaskStepFarmingCohort -na $nw -nt $nt -nm $nm -nd $nd >& $resfile
            speedup=$(cat $resfile | grep Speedup | awk '{print $5;}')
            ideal=$(cat $resfile | grep Speedup | awk '{print $7;}')
            echo "${nm},${nd},${speedup},${ideal}" >> $csvfile
        done
    done
done
